apiVersion: v1
data:
  site-revenue-record.config: "database_uri = \"tcp://clickhouse-miner-stats.data:9000?username=bminer&password=2WHvybnS5vHsrMJ2&database=miner_stats\"\ncolumn_number
    = 8\ninsert_statement = \"INSERT INTO site_revenue(date, site_key, site_name,
    coin, hashrate, reward_per_unit_hashrate, estimation_reward, pool_income) values
    (?,?,?,?,?,?,?,?)\"\nquery_statement = '''\n    SELECT  yesterday(),\n        o.site_key,\n
    \       site.name,\n        coin,\n        hashrate,\n        reward_per_unit_hashrate,\n
    \       hashrate*reward_per_unit_hashrate AS reward,\n        income_amount\n
    \   FROM \n    (\n        SELECT  site_key,\n                algorithm,\n                sum(hashrate15m)/1440000
    AS hashrate\n        FROM miner_card_algorithm_hashrate_new\n        WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n
    \           AND time>subtractDays(now(), 3)\n        GROUP BY  site_key,algorithm
    \n    ) AS o\n    JOIN bminer_algorithm_info ON o.algorithm=bminer_algorithm_info.id\n
    \   JOIN \n    (\n        SELECT  name,\n                avg(reward_per_unit_hashrate)
    AS reward_per_unit_hashrate\n        FROM algorithm_reward\n        WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n
    \       GROUP BY  name \n    ) AS p ON coin=p.name\n    LEFT JOIN \n    (\n        SELECT
    \ site_key,\n                name,\n                sum(income_amount) AS income_amount\n
    \       FROM \n        (\n            SELECT  site_key,\n                    coin
    AS name,\n                    income_amount\n            FROM pool_income_uri\n
    \           LEFT JOIN \n            (\n                SELECT  sum(amount) AS
    income_amount,\n                        normalized_uri\n                FROM miner_pool_reward\n
    \               WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n
    \               GROUP BY  normalized_uri \n            ) AS u ON pool_income_uri.normalized_uri
    = u.normalized_uri \n        )\n        GROUP BY  site_key,name \n    ) AS q ON
    o.site_key = q.site_key AND coin=q.name\n    JOIN site ON o.site_key=site.site_key\n'''"
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"site-revenue-record.config":"database_uri = \"tcp://clickhouse-miner-stats.data:9000?username=bminer\u0026password=2WHvybnS5vHsrMJ2\u0026database=miner_stats\"\ncolumn_number = 8\ninsert_statement = \"INSERT INTO site_revenue(date, site_key, site_name, coin, hashrate, reward_per_unit_hashrate, estimation_reward, pool_income) values (?,?,?,?,?,?,?,?)\"\nquery_statement = '''\n    SELECT  yesterday(),\n        o.site_key,\n        site.name,\n        coin,\n        hashrate,\n        reward_per_unit_hashrate,\n        hashrate*reward_per_unit_hashrate AS reward,\n        income_amount\n    FROM \n    (\n        SELECT  site_key,\n                algorithm,\n                sum(hashrate15m)/1440000 AS hashrate\n        FROM miner_card_algorithm_hashrate_new\n        WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n            AND time\u003esubtractDays(now(), 3)\n        GROUP BY  site_key,algorithm \n    ) AS o\n    JOIN bminer_algorithm_info ON o.algorithm=bminer_algorithm_info.id\n    JOIN \n    (\n        SELECT  name,\n                avg(reward_per_unit_hashrate) AS reward_per_unit_hashrate\n        FROM algorithm_reward\n        WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n        GROUP BY  name \n    ) AS p ON coin=p.name\n    LEFT JOIN \n    (\n        SELECT  site_key,\n                name,\n                sum(income_amount) AS income_amount\n        FROM \n        (\n            SELECT  site_key,\n                    coin AS name,\n                    income_amount\n            FROM pool_income_uri\n            LEFT JOIN \n            (\n                SELECT  sum(amount) AS income_amount,\n                        normalized_uri\n                FROM miner_pool_reward\n                WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n                GROUP BY  normalized_uri \n            ) AS u ON pool_income_uri.normalized_uri = u.normalized_uri \n        )\n        GROUP BY  site_key,name \n    ) AS q ON o.site_key = q.site_key AND coin=q.name\n    JOIN site ON o.site_key=site.site_key\n'''"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"site-revenue-record","namespace":"data"}}
  creationTimestamp: "2021-01-13T07:05:52Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:site-revenue-record.config: {}
      f:metadata:
        f:annotations:
          .: {}
          f:kubectl.kubernetes.io/last-applied-configuration: {}
    manager: kubectl
    operation: Update
    time: "2021-01-13T07:05:52Z"
  name: site-revenue-record
  namespace: data
  resourceVersion: "149668620"
  selfLink: /api/v1/namespaces/data/configmaps/site-revenue-record
  uid: 09d88903-4124-4226-8542-1e0db55b55eb
