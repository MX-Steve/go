apiVersion: v1
data:
  site-revenue-record-new.config: "database_uri = \"tcp://clickhouse-miner-stats.data:9000?username=bminer&password=2WHvybnS5vHsrMJ2&database=miner_stats\"\ncolumn_number
    = 6\ninsert_statement = \"INSERT INTO site_revenue_new(date, site_key,site_name,
    coin, estimation_reward, pool_income) values (?,?,?,?,?,?)\"\nquery_statement
    = '''\n  SELECT  yesterday(),\n          o.site_key,\n          site.name,\n          coin,\n
    \         estimation_reward,\n          income_amount\n  FROM \n      (\n          SELECT
    \ site_key,\n                  coin,\n                  avg(estimation_reward)
    AS estimation_reward\n          FROM \n          (\n              SELECT  time,\n
    \                     site_key,\n                      coin,\n                      estimation_reward,\n
    \                     drift\n              FROM site_estimation_reward\n              LEFT
    JOIN pool_income_uri\n                  ON site_estimation_reward.site_key=pool_income_uri.site_key\n
    \                     AND site_estimation_reward.coin =pool_income_uri.coin\n
    \             WHERE site_estimation_reward.time>subtractDays(now(),3) \n          )\n
    \         WHERE toYYYYMMDD(toDateTime(subtractHours(time,drift),'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n
    \         GROUP BY  site_key,coin \n      )AS o LEFT JOIN \n      (\n          SELECT
    \ site_key,\n                  name,\n                  sum(income_amount) AS
    income_amount\n          FROM \n          (\n              SELECT  site_key,\n
    \                     coin AS name,\n                      income_amount\n              FROM
    pool_income_uri\n              LEFT JOIN \n              (\n                  SELECT
    \ sum(amount) AS income_amount,\n                          normalized_uri\n                  FROM
    miner_pool_reward\n                  WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n
    \                 GROUP BY  normalized_uri \n              ) AS u ON pool_income_uri.normalized_uri
    = u.normalized_uri \n          )\n          GROUP BY  site_key,name \n      )
    AS q ON o.site_key = q.site_key AND coin=q.name\n      JOIN site ON o.site_key=site.site_key\n'''"
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"site-revenue-record-new.config":"database_uri = \"tcp://clickhouse-miner-stats.data:9000?username=bminer\u0026password=2WHvybnS5vHsrMJ2\u0026database=miner_stats\"\ncolumn_number = 6\ninsert_statement = \"INSERT INTO site_revenue_new(date, site_key,site_name, coin, estimation_reward, pool_income) values (?,?,?,?,?,?)\"\nquery_statement = '''\n  SELECT  yesterday(),\n          o.site_key,\n          site.name,\n          coin,\n          estimation_reward,\n          income_amount\n  FROM \n      (\n          SELECT  site_key,\n                  coin,\n                  avg(estimation_reward) AS estimation_reward\n          FROM \n          (\n              SELECT  time,\n                      site_key,\n                      coin,\n                      estimation_reward,\n                      drift\n              FROM site_estimation_reward\n              LEFT JOIN pool_income_uri\n                  ON site_estimation_reward.site_key=pool_income_uri.site_key\n                      AND site_estimation_reward.coin =pool_income_uri.coin\n              WHERE site_estimation_reward.time\u003esubtractDays(now(),3) \n          )\n          WHERE toYYYYMMDD(toDateTime(subtractHours(time,drift),'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n          GROUP BY  site_key,coin \n      )AS o LEFT JOIN \n      (\n          SELECT  site_key,\n                  name,\n                  sum(income_amount) AS income_amount\n          FROM \n          (\n              SELECT  site_key,\n                      coin AS name,\n                      income_amount\n              FROM pool_income_uri\n              LEFT JOIN \n              (\n                  SELECT  sum(amount) AS income_amount,\n                          normalized_uri\n                  FROM miner_pool_reward\n                  WHERE toYYYYMMDD(toDateTime(time,'Asia/Shanghai'))=toYYYYMMDD(yesterday())\n                  GROUP BY  normalized_uri \n              ) AS u ON pool_income_uri.normalized_uri = u.normalized_uri \n          )\n          GROUP BY  site_key,name \n      ) AS q ON o.site_key = q.site_key AND coin=q.name\n      JOIN site ON o.site_key=site.site_key\n'''"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"site-revenue-record-new","namespace":"data"}}
  creationTimestamp: "2021-03-12T03:08:47Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:site-revenue-record-new.config: {}
      f:metadata:
        f:annotations:
          .: {}
          f:kubectl.kubernetes.io/last-applied-configuration: {}
    manager: kubectl
    operation: Update
    time: "2021-03-12T03:08:47Z"
  name: site-revenue-record-new
  namespace: data
  resourceVersion: "172398465"
  selfLink: /api/v1/namespaces/data/configmaps/site-revenue-record-new
  uid: 98d11738-8163-448b-bd23-5dfc771f625b
