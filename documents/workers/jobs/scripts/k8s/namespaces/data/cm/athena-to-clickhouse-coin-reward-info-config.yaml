apiVersion: v1
data:
  coin-reward-info.conf: |-
    {
      "athena_region": "us-west-2",
      "athena_database": "dwh",
      "athena_query": "with coin_info AS (SELECT name, avg(reward_per_unit_hashrate) AS reward_per_unit_hashrate, avg(price) AS price FROM dwh.fact_algorithm_reward WHERE date_diff('day', date, current_date) <= 1 GROUP BY name),card_reward AS (SELECT card, coin, speed*reward_per_unit_hashrate*price AS reward FROM lookup_bminer_speed JOIN coin_info ON lookup_bminer_speed.coin=coin_info.name ORDER BY card),max_reward_card AS (SELECT card, max(reward) AS max_reward FROM card_reward GROUP BY card ) SELECT card_reward.card, coin, max_reward FROM card_reward JOIN max_reward_card ON card_reward.card=max_reward_card.card AND card_reward.reward=max_reward_card.max_reward",
      "clickhouse_uri": "tcp://clickhouse-miner-stats.data:9000?username=bminer&password=2WHvybnS5vHsrMJ2&database=miner_stats",
      "clickhouse_query": "INSERT INTO coin_reward_info (time, card, coin, max_reward) VALUES (?, ?, ?, ?)",
      "append_timestamp": true
    }
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"coin-reward-info.conf":"{\n  \"athena_region\": \"us-west-2\",\n  \"athena_database\": \"dwh\",\n  \"athena_query\": \"with coin_info AS (SELECT name, avg(reward_per_unit_hashrate) AS reward_per_unit_hashrate, avg(price) AS price FROM dwh.fact_algorithm_reward WHERE date_diff('day', date, current_date) \u003c= 1 GROUP BY name),card_reward AS (SELECT card, coin, speed*reward_per_unit_hashrate*price AS reward FROM lookup_bminer_speed JOIN coin_info ON lookup_bminer_speed.coin=coin_info.name ORDER BY card),max_reward_card AS (SELECT card, max(reward) AS max_reward FROM card_reward GROUP BY card ) SELECT card_reward.card, coin, max_reward FROM card_reward JOIN max_reward_card ON card_reward.card=max_reward_card.card AND card_reward.reward=max_reward_card.max_reward\",\n  \"clickhouse_uri\": \"tcp://clickhouse-miner-stats.data:9000?username=bminer\u0026password=2WHvybnS5vHsrMJ2\u0026database=miner_stats\",\n  \"clickhouse_query\": \"INSERT INTO coin_reward_info (time, card, coin, max_reward) VALUES (?, ?, ?, ?)\",\n  \"append_timestamp\": true\n}"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"athena-to-clickhouse-coin-reward-info-config","namespace":"data"}}
  creationTimestamp: "2020-09-07T00:46:18Z"
  name: athena-to-clickhouse-coin-reward-info-config
  namespace: data
  resourceVersion: "100555014"
  selfLink: /api/v1/namespaces/data/configmaps/athena-to-clickhouse-coin-reward-info-config
  uid: 6f16d605-1469-44f3-a825-6d96e0bd8a00
