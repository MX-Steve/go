with coin_info AS (SELECT name, 
  avg(reward_per_unit_hashrate) AS reward_per_unit_hashrate,
  avg(price) AS price 
FROM dwh.fact_algorithm_reward 
WHERE 
  date_diff('hour', from_unixtime(timestamp), current_timestamp) <= 2 GROUP BY  name), 
  card_reward AS (
    SELECT 
      card,coin,price,speed*reward_per_unit_hashrate AS reward,
      speed*reward_per_unit_hashrate*price AS reward_in_usd 
    FROM 
      dwh.lookup_bminer_speed 
    JOIN coin_info 
    ON 
      lookup_bminer_speed.coin=coin_info.name ORDER BY  card),
    max_reward_card AS (
      SELECT 
        card,max(reward_in_usd) AS max_reward 
      FROM 
        card_reward GROUP BY  card ) 
    SELECT 
      card_reward.card,coin,price,reward,reward_in_usd 
    FROM 
      card_reward 
    JOIN max_reward_card 
    ON 
      card_reward.card=max_reward_card.card 
      AND card_reward.reward_in_usd=max_reward_card.max_reward